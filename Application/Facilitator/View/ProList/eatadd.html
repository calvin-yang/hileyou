<extend name="Public/base"/>

<block name="style">

</block>

<block name="body">

    <div class="main-title">
        <h2>{$info['id']?'编辑':'新增'}餐饮</h2>
    </div>
    
    <form action="__SELF__" method="post" class="form-horizontal">

        <div class="form-item cf">
            <label class="item-label">餐饮封面图 *<span class="check-tips"></span></label>
            <div class="controls">
                <div id="main">
                   <div class="demo">
                        <div class="btn">
                            <span class="up_str">上传图片</span>
                             <span class="img_up"><input type="file" name="img" upUrl="{:U('ProList/imgUplode',array('type'=>'eat'))}" at="logo_img_url" onchange="img_upload(this,'1');"></span>
                            <input id="logo_img_url" type="hidden" name="logo_img_url" value="{$info.logo_img_url}" />
                        </div>
                        <div class="progress">
                            <span class="bar"></span><span class="percent">0%</span >
                        </div>
                        <div class="files"></div>
                   </div>
                    <php>$img_url = getImgUrl($info['logo_img_url']);</php>
            
                   <div class="col-md-12 column" id="showimg"><notempty name="info.logo_img_url"><div style='float: left;margin-left: 5px;'><img src="{:($img_url)?$img_url[0]['url']:''}" width='220px' height = '111px'></div></notempty></div>
                </div>
            </div>
        </div>

        <div class="form-item cf">
            <label class="item-label">餐饮图片<span class="check-tips"></span></label>
            <div class="controls">
                <div id="main">
                   <div class="demo">
                        <div class="btn">
                            <span class="up_str">上传图片</span>
                            <span class="img_up"><input type="file" name="img" upUrl="{:U('ProList/imgUplode',array('type'=>'eat'))}" at="foot_img_url" dele="" onchange="img_upload(this,'2');"></span>
                            <input id="foot_img_url" type="hidden" name="foot_img_url" value="{$info.foot_img_url}" />
                        </div>
                        <div class="progress">
                            <span class="bar"></span><span class="percent">0%</span >
                        </div>
                        <div class="files"></div>
                   </div>
                   <div class="col-md-12 column" id="showimg">
                        <php>
                        if($info['foot_img_url'] != ''){
                            $imgUrl = getImgUrl($info['foot_img_url']);
                            foreach($imgUrl as $hel_img_list){
                                echo "<div style='float: left;margin-left: 5px;'><span class='dele' img_delete='".U('ProList/img_delete')."' protype='eat2' imgurl='foot_img_url' proid='".$hel_img_list['id']."' style='float:right;cursor:pointer;' onclick='img_delete(this);'>删除</span><img src='".$hel_img_list['url']."' class='img' width='220px' height = '111px'></div>";
                            }
                        }
                        
                        </php>
                       
                   </div>
                </div>
            </div>
        </div>

        <div class="form-item cf">
            <label class="item-label">环境图片<span class="check-tips"></span></label>
            <div class="controls">
                <div id="main">
                   <div class="demo">
                        <div class="btn">
                            <span class="up_str">上传图片</span>
                            <span class="img_up"><input type="file" name="img" upUrl="{:U('ProList/imgUplode',array('type'=>'eat'))}" at="environment_img_url" dele="" onchange="img_upload(this,'2');"></span>
                            <input id="environment_img_url" type="hidden" name="environment_img_url" value="{$info.environment_img_url}" />
                        </div>
                        <div class="progress">
                            <span class="bar"></span><span class="percent">0%</span >
                        </div>
                        <div class="files"></div>
                   </div>
                   <div class="col-md-12 column" id="showimg">
                        <php>
                        if($info['environment_img_url'] != ''){
                            $imgUrl = getImgUrl($info['foot_img_url']);
                            foreach($imgUrl as $environment_img_list){
                                echo "<div style='float: left;margin-left: 5px;'><span class='dele' img_delete='".U('ProList/img_delete')."' protype='eat1' imgurl='environment_img_url' proid='".$environment_img_list['id']."' style='float:right;cursor:pointer;' onclick='img_delete(this);'>删除</span><img src='".$environment_img_list['url']."' class='img' width='220px' height = '111px'></div>";
                            }
                        }
                        
                        </php>
                       
                   </div>
                </div>
            </div>
        </div>

        


        <div class="form-item cf">
            <label class="item-label">餐饮店名<span class="check-tips"></span></label>
            <div class="controls">
                <input type="text" class="text input-large " name="foot_name" value="{$info.foot_name}">*
            </div>
        </div>

        <div class="form-item cf">
            <label class="item-label">营业时间<span class="check-tips"></span></label>
            <div class="controls">
                <input type="time" class="text input-large " style="width:100px" name="business_hours1" value="{$info.business_hours1}">-
                <input type="time" class="text input-large " style="width:100px" name="business_hours2" value="{$info.business_hours2}">
            </div>
        </div>
        
        
        <div class="form-item cf">
            <label class="item-label">餐饮电话<span class="check-tips"></span></label>
            <div class="controls">
                <input type="text" class="text input-large " name="foot_tel" value="{$info.foot_tel}">*
            </div>
        </div>


        <div class="form-item cf">
            <label class="item-label">餐饮类型<span class="check-tips"></span></label>
            <div class="">
                <select style="width: 300px" class="chzn-select" id="type" name="type">
                    <volist name="eat_type_list['name']" id="vo">
                        <option value="{$vo}" <if condition="$info.type eq $vo">selected</if>>{$vo}</option>
                    </volist>
                </select>*
            </div>
        </div>

        <div class="form-item cf">
            <label class="item-label">省份<span class="check-tips"></span></label>
            <div class="">
                <select style="width: 300px" class="chzn-select" id="provinces" name="provinces">
                        <option value="">--请选择--</option>
                </select>
            </div>
        </div>
        <!-- 市 -->
        <div class="form-item cf city"></div>
        <!-- 区 -->
        <div class="form-item cf county"></div>

        <div class="form-item cf">
            <label class="item-label">所在地址<span class="check-tips"></span></label>
            <div class="controls">
                <input type="text" class="text input-large " name="address" value="{$info.address}">*
            </div>
        </div>
        
        
        <div class="form-item cf">
            <label class="item-label">附近交通<span class="check-tips"></span></label>
            <div class="controls">
                <label class="textarea input-large">
                    <textarea name="nearby_traffic">{$info.nearby_traffic|default=''}</textarea>
                </label>
            </div>
        </div>
        


        <div class="form-item cf">
            <label class="item-label">(￥)消费<span class="check-tips"></span></label>
            <div class="controls">
                <input type="number" class="text input-large price" name="per_capita" value="{$info.per_capita|default=0}">*
            </div>
        </div>

        <div class="form-item cf">
            <label class="item-label">(￥)优惠价<span class="check-tips">(0：无优惠价)</span>
                <if condition="$info['voucher'] != ''">
                    <input type="number" class="text input-large " name="zhekou" value="{:round($info['favorable_price']/$info['per_capita'],2)*100}"  style="width:50px;" oninput="OnInput (this,event)" onpropertychange="OnPropChanged (this,event)">%

                <else />
                    <input type="number" class="text input-large " name="zhekou" value="0"  style="width:50px;" oninput="OnInput (this,event)" onpropertychange="OnPropChanged (this,event)" >%
                </if>
            </label>
            <div class="controls">
                <input type="number" class="text input-large favorable_price" name="favorable_price" value="{$info.favorable_price|default=0}">
            </div>
        </div>


        <!-- vip价 start -->
        <volist name="vip_list" id="vo">
            <div class="form-item cf">
                <label class="item-label">(%折){$vo.name}价<span class="check-tips">(0：无vip价)</span></label>
                <div class="controls">
                    <input type="number" class="text input-large " name="vip[]" value="{:$vo['discount']}">
                    <input type="hidden" class="text input-large " name="vip_id[]" value="{$vo.id}">
                </div>
            </div>
        </volist>
        <!-- vip价 end-->

        <div class="form-item cf">
            <label class="item-label">(￥)现金劵<span class="check-tips">(/一百元)</span></label>
            <div class="controls">
                <input type="number" class="text input-large" name="voucher" value="{$info.voucher}">*
            </div>
        </div>

        <div class="form-item cf">
            <label class="item-label">现金券有效时间<span class="check-tips"></span></label>
            <div class="controls date" id="datetimepicker" style="display:inline-block">
                <input type="text" id="time-end" name="effective_time" class="text input-large" value="{:time_format($info['effective_time'],'Y-m-d')}" placeholder="有效时间" />
                <span class="add-on"><i class="icon-th"></i></span>
            </div>
        </div>

        

        <div class="form-item cf">
            <label class="item-label">排序<span class="check-tips"></span></label>
            <div class="controls">
                <input type="number" class="text input-large " name="sort" value="{$info.sort}">
            </div>
        </div>
        

        <div class="form-item">
            <input type="hidden" name="id" value="{$info.id|default=''}">
            <button class="btn submit-btn ajax-post" id="submit" type="submit" target-form="form-horizontal">确 定</button>
            <button class="btn btn-return" onclick="javascript:history.back(-1);return false;">返 回</button>
        </div>
    </form>
</block>

<block name="script">
     <!-- 日历插件 -->
    <link href="__STATIC__/datetimepicker/css/datetimepicker.css" rel="stylesheet" type="text/css">
    <php>if(C('COLOR_STYLE')=='blue_color') echo '<link href="__STATIC__/datetimepicker/css/datetimepicker_blue.css" rel="stylesheet" type="text/css">';</php>
    <link href="__STATIC__/datetimepicker/css/dropdown.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="__STATIC__/datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
    <script type="text/javascript" src="__STATIC__/datetimepicker/js/locales/bootstrap-datetimepicker.zh-CN.js" charset="UTF-8"></script>
    <!-- 日历插件 -->

    <script type="text/javascript">

        // 运用日历插件
        $('#datetimepicker').datetimepicker({
           format: 'yyyy-mm-dd',
            language:"zh-CN",
            minView:2,
            autoclose:true,
            pickerPosition:'bottom-left'
        });
        
        $("#submit").click(function(){
            $("#facilities").val($("#facilitie").val());
        });

       	
        //导航高亮
        $('.side-sub-menu').find('a[href="{:U('ProList/eatlist')}"]').closest('li').addClass('current');
        // 然后在select元素上启用chose
        jQuery("#facilitie").chosen({disable_search_threshold: 5});
        jQuery("#type").chosen({disable_search_threshold: 5});
        jQuery("#bed_type").chosen({disable_search_threshold: 5});
        
        function img_delete(_this){
            var img_url = $(_this).parent().find('.img').attr('src');
            var img_delete_url = $(_this).attr('img_delete');
            var id = "{:$_GET['id']}";
            $(_this).parent().remove();
            $.ajax({
                url : img_delete_url,
                data : {'img_url' : img_url,'type' : 'ProList','id' : id},
                type : 'POST',
                success : function(data){
                    
                    $("#hel_img_url").val(data);
                }

            });
        };


        $("document").ready(function(){
            var provinces = "{:$info['provinces']}";
            var citys = "{:$info['citys']}";
            var countys = "{:$info['countys']}";
            $.ajax({
                type: "get",
                url: "{:U('Region/action')}", // type=1表示查询省份
                data: {"parent_id": "1", "type": "1"},
                dataType: "json",
                success: function(data) {
                    $.each(data, function(i, item) {
                        $("#provinces").append("<option value='" + item.region_id + "'>" + item.region_name + "</option>");
                    });
                    $("#provinces").val(provinces);
                    jQuery("#provinces").chosen({disable_search_threshold: 5});
                }
            });

            $.ajax({
                type: "get",
                url: "{:U('Region/action')}", // type =2表示查询市
                data: {"parent_id": provinces, "type": "2"},
                dataType: "json",
                success: function(data) {
                    $(".city").html('<label class="item-label">市区<span class="check-tips"></span></label><div class=""><select style="width: 300px" class="chzn-select" id="citys" name="citys" onchange="citys_change(this);"><option value="">--请选择--</option></select></div>');
                    $.each(data, function(i, item) {
                        $("#citys").append("<option value='" + item.region_id + "'>" + item.region_name + "</option>");
                    });
                    $("#citys").val(citys);
                    jQuery("#citys").chosen({disable_search_threshold: 5});
                }
            });

            $.ajax({
                type: "get",
                url: "{:U('Region/action')}", // type =2表示查询市
                data: {"parent_id": citys, "type": "3"},
                dataType: "json",
                success: function(data) {
                    $(".county").html('<label class="item-label">县区<span class="check-tips"></span></label><div class=""><select style="width: 300px" class="chzn-select" id="countys" name="countys"><option value="">--请选择--</option></select></div>');
                    $.each(data, function(i, item) {
                        $("#countys").append("<option value='" + item.region_id + "'>" + item.region_name + "</option>");
                    });
                    $("#countys").val(countys);
                    jQuery("#countys").chosen({disable_search_threshold: 5});
                }
            });

        });

        $("#provinces").change(function() {
            $.ajax({
                type: "get",
                url: "{:U('Region/action')}", // type =2表示查询市
                data: {"parent_id": $(this).val(), "type": "2"},
                dataType: "json",
                success: function(data) {
                    $(".city").html('<label class="item-label">市区<span class="check-tips"></span></label><div class=""><select style="width: 300px" class="chzn-select" id="citys" name="citys" onchange="citys_change(this);"><option value="">--请选择--</option></select></div>');
                    $.each(data, function(i, item) {
                        $("#citys").append("<option value='" + item.region_id + "'>" + item.region_name + "</option>");
                    });

                    jQuery("#citys").chosen({disable_search_threshold: 5});
                }
            });
        });

        function citys_change(_this){
            $.ajax({
                type: "get",
                url: "{:U('Region/action')}", // type =2表示查询市
                data: {"parent_id": $(_this).val(), "type": "3"},
                dataType: "json",
                success: function(data) {
                    $(".county").html('<label class="item-label">县区<span class="check-tips"></span></label><div class=""><select style="width: 300px" class="chzn-select" id="countys" name="countys"><option value="">--请选择--</option></select></div>');
                    $.each(data, function(i, item) {
                        $("#countys").append("<option value='" + item.region_id + "'>" + item.region_name + "</option>");
                    });
                    jQuery("#countys").chosen({disable_search_threshold: 5});
                }
            });
        }
    </script>

     <script type="text/javascript">
    // Firefox, Google Chrome, Opera, Safari, Internet Explorer from version 9
        function OnInput (_this,event) {
            var price = $(".price").val();

            if(price != ""){
                var favorable_price = price * ($(_this).val()/100);
                $('.favorable_price').val(favorable_price);
            }
        }
    // Internet Explorer
        function OnPropChanged (_this,event) {
            if (event.propertyName.toLowerCase () == "value") {
                var price = $(".price").val();
                if($price != ""){
                    var favorable_price = price * $(_this).val();
                    $('favorable_price').val(favorable_price);
                }
            }
        }
    </script>

</block>